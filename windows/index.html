<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no, minimal-ui" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta name="msapplication-TileColor" content="#53749d" />
        <link href="style.css" rel="stylesheet" />
        <title>##Orz 改名部</title>
    </head>
    <body>

        <header class="titlebar bar">
            <div id="back_button" class="icon titleitem barbutton" src="orz.gif"></div>
            <div class="title titleitem">##Orz 改名部</div>
        </header>
        <form class="container" action="" method="post">
            <div>##Orz 分部喵 - daily.orz.chat -</div>
            <textarea id="newname" class="textbox" placeholder="New name" autofocus="autofocus" rows="5">FIXME: original name should be here</textarea>
            <button type="submit" class="button legacy_support">保存</button>
        </form>
        <div id="modal_wrap" class="modal_wrap invisible"></div>
        <footer id="footer" class="bar legacy_support invisible">
            <div id="submit_button" class="barbutton save_button"><div class="desc">保存</div></div>
            <div id="more_button" class="barbutton more_button"><!--&#xE10C;--></div>
        </footer>


        <script><!--
            footer_expanded = false;

            function forEachOfClass(className, callback) {
                [].forEach.call(document.getElementsByClassName(className), callback);
            }

            function goBack() {
                    history.back();
                    window.close();
                    setTimeout(function() {
                        window.open('tg:join?invite=A8eCpTuqXjqpZZefNH8Omg','_self');
                    }, 0.2);
            }
            function updateName(newName) {
                // TODO
                return confirm("[STUB] Change name to "+newName+"?");
            }
            function showPrompt(content, callback) {
                // FIXME
                alert(content);
                callback();
            }
            function toggleFooter() {
                footer_expanded = !footer_expanded;
                footer.classList.toggle("expand");
                [].forEach.call(document.getElementsByClassName("desc"), function (ele) {
                    ele.classList.toggle("invisible");
                });
                modal_wrap.classList.toggle("invisible");
                more_button.focus();
            }

            forEachOfClass("desc", function(e) {
                e.classList.toggle("invisible");
            })
            forEachOfClass("legacy_support", function(e) {
                e.classList.toggle("invisible");
            })

            back_button.addEventListener("click", goBack);
            submit_button.addEventListener("click", function() {
                newname.disabled = true;
                submit_button.classList.add("disabled");
                back_button.classList.add("disabled");

                if(updateName(newname.value)) {
                    goBack();
                } else {
                    showPrompt("更新失败。", function() {
                        newname.disabled = false;
                        submit_button.classList.remove("disabled");
                        back_button.classList.remove("disabled");
                    });
                }
            });
            more_button.addEventListener("click", toggleFooter);
            modal_wrap.addEventListener("click", toggleFooter);
            window.addEventListener("blur", function() {
                if(footer_expanded) toggleFooter();
            })
        --></script>
    </body>
</html>
